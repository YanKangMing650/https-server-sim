# 【详细设计文档检视报告】模块联调设计

**检视模块名称**: 模块联调设计
**文档版本**: v10
**检视日期**: 2026-02-20
**检视人员**: 详细设计检视专家

---

## 1. 检视概述

### 1.1 检视模块基本信息
- **模块名称**: 模块联调设计
- **唯一标识**: LLD-INTEG-v10
- **检视范围**: `docs/design/lld-模块联调设计.md` 完整文档（v10版本）

### 1.2 输入文件
1. **架构设计文档**: `docs/design/hld-架构设计文档.md`
2. **模块联调设计文档**: `docs/design/lld-模块联调设计.md` (v10)
3. **代码实现**: `codes/core/` 目录下头文件和源文件

### 1.3 检视范围
- 文档所有章节
- 所有图形（时序图、依赖图）
- 所有设计逻辑
- 接口契约定义
- 联调步骤与Checklist

### 1.4 检视依据
1. 现有代码实现（`codes/core/` 目录）
2. 架构设计文档（`hld-架构设计文档.md`）
3. 各模块详细设计文档
4. 模块设计师Agent Prompt要求

### 1.5 评分结果

| 维度 | 满分 | 得分 | 扣分说明 |
|-----|------|------|---------|
| 架构一致性 | 30 | 22 | 接口定义与实际代码部分不一致，部分流程描述与代码不符 |
| 落地可行性 | 30 | 24 | 部分接口契约细节缺失，配置映射关系不明确 |
| 文档清晰度 | 25 | 21 | 部分术语前后不一致，部分描述存在歧义 |
| 图形准确性 | 15 | 12 | 时序图部分交互与实际代码不符 |
| **总分** | **100** | **79** | - |

### 1.6 整体结论
整体符合架构约束，文档结构完整，包含了联调设计的核心要素。存在 **0处致命问题**、**4处严重问题**、**8处一般问题**、**3处不清晰点**。建议按严重程度优先级修正后可用于指导联调工作。

---

## 2. 核心问题清单

按严重程度排序：致命问题 → 严重问题 → 一般问题 → 不清晰点 → 过度设计点

| 问题 ID | 问题所属维度 | 问题严重程度 | 问题具体位置 | 问题详细描述 | 针对性修改建议 |
|---------|-------------|-------------|-------------|-------------|---------------|
| **严重问题** |
| JZ-SJ-001 | 架构一致性-接口一致性 | 严重 | 4.1 已实现接口表（序号15） | 文档中 `Connection::set_protocol_handler()` 被标记为"内部接口"，但从代码看，该方法是public方法，且需要外部（Server或ACCEPT handler）调用，属于模块间接口 | 1. 修改接口类型为"模块间接口"；2. 补充该接口的调用方说明（Server/ACCEPT handler）；3. 在接口契约章节补充完整的调用时序 |
| JZ-SJ-002 | 架构一致性-职责边界 | 严重 | 5.3 接口契约（handle_accept示例代码） | 示例代码中 `handle_accept` 的实现逻辑与实际代码中Server注册ACCEPT handler的方式不一致。文档展示的是"伪代码"，但未明确说明 | 1. 明确标注示例代码为"设计示意"而非实际代码；2. 或参考 `server.cpp` 中的实际实现修正示例；3. 补充说明ACCEPT handler实际在Server中如何注册 |
| JZ-LD-001 | 落地可行性-接口契约 | 严重 | 5.4 Connection与ProtocolHandler接口契约 | 配置结构体映射不清晰：`Config::CertificatesConfig` 与 `protocol::CertConfig` 是两个不同结构体，文档仅说明需要转换，但未说明转换逻辑、位置、责任人 | 1. 补充完整的配置转换代码示例；2. 明确转换逻辑的实现位置（哪个模块负责）；3. 补充字段映射的完整表格（包含国密相关字段） |
| JZ-TX-001 | 图形准确性-时序图 | 严重 | 3.1 HTTPS请求响应完整流程时序图 | 时序图中多处交互与实际代码不符：<br/>1. `Server->MC: add_listen_fd(fd, port)` 实际有port参数，图中参数展示不完整<br/>2. `EL->CM: create_connection(fd, port)` 实际参数正确，但后续设置ClientInfo的调用缺失<br/>3. ProtocolHandler创建和初始化流程标注为"设计规划"，但基类接口已定义 | 1. 修正时序图中的参数展示；2. 补充 `Connection::set_client_info()` 的调用；3. 重新梳理"已实现" vs "设计规划"的边界，基类已定义的接口应标注为"已实现" |
| **一般问题** |
| JZ-SJ-003 | 架构一致性-接口一致性 | 一般 | 4.1 已实现接口表（序号18） | `MsgCenter::post_callback_task()` 的参数类型标注有误，实际代码参数是 `std::function<void()>`，文档未明确说明 | 修正参数类型说明，补充完整的函数签名 |
| JZ-SJ-004 | 架构一致性-需求覆盖 | 一般 | 9.4 阶段3 Checklist（3.3-3.6） | Checklist中HTTP/1.1请求解析相关项标注为"未实现"，但 `HttpParser` 类和 `Http1Handler::on_read()` 框架已存在 | 重新验证实际代码实现状态，更新Checklist标注（如改为"部分实现"） |
| JZ-LD-002 | 落地可行性-流程描述 | 一般 | 2.3 ProtocolHandler初始化顺序 | 文档说明ProtocolHandler初始化在"连接创建后按需初始化"，但未明确：<br/>1. 由谁负责创建ProtocolHandler<br/>2. 如何选择Http1Handler还是Http2Handler<br/>3. 初始化失败的处理逻辑 | 补充ProtocolHandler工厂的选择逻辑、创建责任方、错误处理流程 |
| JZ-LD-003 | 落地可行性-测试用例 | 一般 | 10. 联调测试用例 | 集成测试用例映射表中，部分用例ID与实际测试文件中的TEST名称不完全对应（如Integration_UseCase001等） | 核对 `codes/core/test/integration_tests/` 下的实际TEST名称，更新映射表 |
| JZ-WD-001 | 文档清晰度-术语统一 | 一般 | 2.1 依赖关系图 vs 2.2 模块依赖层级 | 模块命名不一致：<br/>- 图中: `https_server_sim::ConnectionManager`<br/>- 表中: `ConnectionManager`<br/>- 应统一命名风格 | 统一模块命名方式，建议使用完整命名空间或一致的简化名 |
| JZ-WD-002 | 文档清晰度-内容描述 | 一般 | 5.7 WorkerPool与CallbackRegistry接口契约 | 代码示例中引用了 `request_data` 和 `request_len` 变量，但未说明这些变量的来源和类型 | 补充变量来源说明，或完善示例代码使其逻辑完整 |
| JZ-WD-003 | 文档清晰度-格式规范 | 一般 | 11. 未来规划 | 该章节内容与"设计规划"标注的内容重复（DebugChain、Callback已在前面标注），建议整合 | 整合重复内容，或将"未来规划"改为"后续优化方向"，聚焦于Phase4-6之后的规划 |
| JZ-TX-002 | 图形准确性-依赖图 | 一般 | 2.1 依赖关系图 | 图中Server指向MsgCenter的依赖关系正确，但未体现Server通过Event.handler调用ConnectionManager的间接关系 | 补充标注或说明"Event.handler是Server注册的函数"这一关键逻辑 |
| **不清晰点** |
| JZ-BQ-001 | 文档清晰度-待确认内容 | 不清晰 | 6.5 配置结构体传递约定 | `CertificatesConfig` 与 `CertConfig` 的字段映射不完整，特别是国密相关字段（sm2_cert_path等）在 `CertConfig` 中无对应字段 | 明确国密字段的处理策略：是扩展 `CertConfig` 还是在映射时忽略 |
| JZ-BQ-002 | 文档清晰度-待确认内容 | 不清晰 | 8.1 线程安全保证表 | `Connection::get_id()`、`get_fd()`、`get_state()` 的线程安全标注为"◐ 有限"，说明不够精确。实际这些是const方法，读取原子变量或不可变成员 | 细化线程安全说明，区分"原子变量读取" vs "非原子变量读取" |
| JZ-BQ-003 | 文档清晰度-待确认内容 | 不清晰 | 7.3 资源清理责任约定 | `ProtocolHandler` 的创建者标注为"外部创建"，但未明确这个"外部"具体指哪个模块（Server? ConnectionManager? 其他?） | 明确ProtocolHandler的创建责任方模块 |

---

## 3. 整体评价

### 3.1 合规项
1. **文档结构完整**：严格遵循了联调设计文档的预期结构，包含了模块依赖关系、核心交互流程、接口汇总表、接口契约、数据结构约定、错误处理约定、线程安全约定、联调步骤Checklist、测试用例等完整章节
2. **架构整体一致**：核心模块划分、依赖关系层级与架构设计文档保持一致
3. **已实现 vs 设计规划区分清晰**：使用 ⚠️ 标记明确区分了已实现和设计规划内容，避免混淆
4. **Checklist实用性强**：联调阶段划分合理，Checklist可操作性强，与实际代码实现状态对应
5. **接口契约详细**：对核心接口（Server-MsgCenter、Connection-ProtocolHandler等）的契约描述较为详细，包含了调用方、被调用方、代码示例、双方保证等

### 3.2 待改进项
- **架构一致性**: 需重点修正 **4处严重问题**，特别是接口分类、示例代码与实际代码的一致性
- **落地可行性**: 需补充配置映射逻辑、ProtocolHandler创建流程、测试用例与实际代码的对应
- **文档清晰度**: 需统一术语、补充变量说明、整合重复内容
- **图形准确性**: 需修正时序图中的交互细节

### 3.3 落地性评估
基于检视结果，**修正所有问题后，文档可直接指导联调工作**。当前版本已具备良好的基础，主要需要修正与实际代码不一致的细节，补充缺失的映射逻辑。

---

## 4. 修改建议总纲

### 4.1 修改优先级

| 优先级 | 问题类型 | 建议完成时间 |
|-------|---------|-------------|
| P0（紧急） | 严重问题（4处） | 联调开始前 |
| P1（高） | 一般问题（8处） | 联调第一阶段前 |
| P2（中） | 不清晰点（3处） | 联调第二阶段前 |

### 4.2 各维度修改核心方向

#### 架构一致性维度
- **重点**: 校验接口定义与实际代码的一致性
- **具体**:
  1. 修正 `set_protocol_handler()` 的接口类型（内部→模块间）
  2. 重新核对所有已实现接口的签名、参数、返回值
  3. 更新示例代码，使其与 `server.cpp` 中的实际实现一致
  4. 明确ProtocolHandler创建的责任方

#### 落地可行性维度
- **重点**: 补充配置映射逻辑、完善接口契约细节
- **具体**:
  1. 补充 `CertificatesConfig` → `CertConfig` 的完整转换代码
  2. 明确ProtocolHandler选择逻辑（HTTP/1.1 vs HTTP/2）
  3. 更新Checklist，与实际实现状态保持一致
  4. 修正集成测试用例映射表

#### 文档清晰度维度
- **重点**: 统一术语、消除歧义
- **具体**:
  1. 统一模块命名方式
  2. 补充代码示例中变量的来源说明
  3. 整合"设计规划"与"未来规划"的重复内容
  4. 细化线程安全说明

#### 图形准确性维度
- **重点**: 修正时序图与实际代码的不符
- **具体**:
  1. 补充 `set_client_info()` 调用
  2. 修正参数展示
  3. 重新确认"已实现" vs "设计规划"的边界

### 4.3 二次检视提示
修改完成后，建议重点检视以下内容：
1. **架构一致性**: 所有接口定义与头文件一致
2. **图形准确性**: 时序图与文字描述、代码实现三者一致
3. **落地可行性**: 配置转换逻辑完整、可直接实现

---

## 5. 详细代码比对记录

### 5.1 Server模块接口比对

| 文档描述 | 实际代码 (server.hpp) | 一致性 |
|---------|----------------------|--------|
| `Server::init(config_file)` | `int init(const std::string& config_file)` | ✓ 一致 |
| `Server::start()` | `int start()` | ✓ 一致 |
| `Server::stop()` | `int stop()` | ✓ 一致 |
| `Server::cleanup()` | `void cleanup()` | ✓ 一致 |

### 5.2 ConnectionManager模块接口比对

| 文档描述 | 实际代码 (connection_manager.hpp) | 一致性 |
|---------|----------------------|--------|
| `create_connection(fd, port)` | `std::shared_ptr<Connection> create_connection(int fd, uint16_t server_port)` | ✓ 一致 |
| `get_connection(conn_id)` | `std::shared_ptr<Connection> get_connection(uint64_t conn_id)` | ✓ 一致 |
| `remove_connection(conn_id)` | `void remove_connection(uint64_t conn_id)` | ✓ 一致 |
| `close_all()` | `void close_all()` | ✓ 一致 |

### 5.3 Connection模块接口比对

| 文档描述 | 实际代码 (connection.hpp) | 一致性 |
|---------|----------------------|--------|
| `set_protocol_handler(handler)` | `void set_protocol_handler(std::unique_ptr<ProtocolHandler> handler)` | ✓ 一致（但接口类型标注有误） |
| `get_protocol_handler()` | `ProtocolHandler* get_protocol_handler()` | ✓ 一致 |
| `transition_to(state)` | `void transition_to(ConnectionState new_state)` | ✓ 一致 |
| `set_client_info(ip, port)` | `void set_client_info(const std::string& ip, uint16_t port)` | ✓ 一致 |

### 5.4 ProtocolHandler模块接口比对

| 文档描述 | 实际代码 (protocol_handler.hpp) | 一致性 |
|---------|----------------------|--------|
| `init(conn, cert_config, tls_config)` | `int init(Connection* conn, const CertConfig& cert_config, const TlsConfig& tls_config)` | ✓ 一致 |
| `on_read()` | `int on_read()` | ✓ 一致 |
| `on_write()` | `int on_write()` | ✓ 一致 |
| `send_response(data, len)` | `int send_response(const uint8_t* data, uint32_t len)` | ✓ 一致 |

### 5.5 MsgCenter模块接口比对

| 文档描述 | 实际代码 (msg_center.hpp) | 一致性 |
|---------|----------------------|--------|
| `start()` | `int start()` | ✓ 一致 |
| `stop()` | `void stop()` | ✓ 一致 |
| `add_listen_fd(fd, port)` | `int add_listen_fd(int fd, uint16_t port)` | ✓ 一致 |
| `post_event(event)` | `void post_event(const Event& event)` | ✓ 一致 |
| `post_callback_task(task)` | `void post_callback_task(std::function<void()> task)` | ✓ 一致（文档参数说明不完整） |

---

## 附录：关键文件清单

| 模块 | 头文件路径 | 源文件路径 |
|-----|-----------|-----------|
| Server | `codes/core/server/include/server/server.hpp` | `codes/core/server/source/server.cpp` |
| Connection | `codes/core/connection/include/connection/connection.hpp` | `codes/core/connection/source/connection.cpp` |
| ConnectionManager | `codes/core/connection/include/connection/connection_manager.hpp` | `codes/core/connection/source/connection_manager.cpp` |
| ProtocolHandler | `codes/core/protocol/include/protocol/protocol_handler.hpp` | `codes/core/protocol/source/protocol_handler.cpp` |
| MsgCenter | `codes/core/msg_center/include/msg_center/msg_center.hpp` | `codes/core/msg_center/source/msg_center.cpp` |
| Event | `codes/core/msg_center/include/msg_center/event.hpp` | - |
| Config | `codes/core/config/include/config/config.hpp` | `codes/core/config/source/config.cpp` |

---

**报告结束**

**检视报告生成时间**: 2026-02-20
**报告版本**: v1.0
**下次检视建议**: 修正后进行二次检视，重点关注架构一致性和图形准确性
