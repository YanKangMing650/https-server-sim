# 【详细设计文档检视报告】模块联调设计

**文档版本**: v2
**检视日期**: 2026-02-20
**初始评分**: 68分

---

## 检视概述

| 项目 | 内容 |
|-----|------|
| 检视模块名称 | 模块联调设计 |
| 输入文件 | 架构设计文档、4+1视图、各模块详细设计、现有代码实现、集成测试用例 |
| 检视范围 | lld-模块联调设计.md 所有章节 |
| 检视依据 | 架构设计文档、模块设计师Agent prompt、现有代码实现 |

**整体结论**: 文档覆盖了模块联调的核心内容，但存在多处与现有代码实现不一致、描述不清晰、缺乏具体落地细节的问题，需补充完善后才能有效指导联调工作。

---

## 核心问题清单（按严重程度排序）

| 问题 ID | 问题所属维度 | 严重程度 | 扣分 | 问题具体位置 | 问题详细描述 | 针对性修改建议 |
|---------|-------------|---------|------|-------------|-------------|---------------|
| LT-001 | 架构一致性-与代码实现不一致 | 致命 | 10 | 2.2 模块依赖层级、2.3 初始化顺序 | 初始化顺序与实际代码不符：<br>1. 文档写 Utils→Config→MsgCenter→DebugChain→ConnectionManager→Server<br>2. 但实际Server::init()内部顺序是：Config加载→init_listen_sockets→创建ConnectionManager→创建MsgCenter<br>3. DebugChain模块在代码中未被Server模块直接依赖 | 1. 根据codes/core/server/source/server.cpp的实际实现修正初始化顺序<br>2. 验证DebugChain是否为Server直接依赖，若否，从依赖图中移除或调整依赖层级 |
| LT-002 | 落地可行性-接口契约与代码不一致 | 致命 | 10 | 4.2 Server与MsgCenter的接口契约、4.3 Server与ConnectionManager的接口契约 | 接口契约描述与实际代码不符：<br>1. Server::start()中代码是先启动MsgCenter，再add_listen_fd<br>2. 但4.2节契约1写"先添加listen fd，再启动MsgCenter"<br>3. ConnectionManager::create_connection()实际返回std::shared_ptr&lt;Connection&gt;，但契约描述不明确 | 1. 对照codes/core/server/source/server.cpp修正接口契约描述<br>2. 明确create_connection()返回值类型为std::shared_ptr&lt;Connection&gt;<br>3. 修正start()中MsgCenter启动与add_listen_fd的顺序 |
| LT-003 | 文档清晰度-存在未解决疑问 | 严重 | 5 | 3.1 时序图第156行、4.3节第377行 | 文档中存在多处"待确认"、问号等未明确内容：<br>1. 第156行："Srv-&gt;MC: add_listen_fd(fd, port)?"<br>2. 第157行："实际上是add_conn_fd（待确认）"<br>3. 第377行："还是由Server创建后set进去？待确认代码实现" | 1. 查阅现有代码实现，明确add_listen_fd/add_conn_fd的实际使用<br>2. 明确ProtocolHandler的创建职责（Connection内部创建还是外部注入）<br>3. 移除所有"待确认"、问号等模糊表述 |
| LT-004 | 落地可行性-缺少Callback模块联调内容 | 严重 | 5 | 全文 | 架构设计文档中Callback是核心模块，但本文档：<br>1. 2.1依赖关系图中未包含Callback模块<br>2. 2.2依赖层级表中未包含Callback模块<br>3. 3.1请求响应流程中未体现Callback处理流程<br>4. 4.x接口契约中无Callback相关内容 | 1. 在依赖关系图和依赖层级中补充Callback模块<br>2. 在3.1请求响应流程中补充WorkerPool调用Callback的完整流程<br>3. 新增Callback模块与其他模块的接口契约章节 |
| LT-005 | 落地可行性-缺少DebugChain模块联调内容 | 严重 | 5 | 全文 | DebugChain在架构中是重要模块，但本文档：<br>1. 3.1请求响应流程中仅在注释中提到DebugChain（第201行），无实际交互流程<br>2. 4.x接口契约中无DebugChain相关内容<br>3. 6.x Checklist中DebugChain测试项过少 | 1. 在3.1请求响应流程中补充DebugChain::process_request()和process_response()的交互<br>2. 新增DebugChain模块与Protocol/Connection模块的接口契约<br>3. 在Checklist中补充DebugChain各Handler（延迟、断开、日志、错误码）的测试项 |
| LT-006 | 文档清晰度-缺少模块接口清单 | 严重 | 5 | 全文 | 联调文档核心是模块间接口，但本文档：<br>1. 没有汇总的模块间接口清单表格<br>2. 接口契约分散在各小节，不便于查阅<br>3. 未明确哪些接口是跨模块必须实现的 | 1. 新增"模块间接口汇总表"章节<br>2. 按调用方-被调用方分类列出所有接口<br>3. 明确每个接口的参数、返回值、错误码约定 |
| LT-007 | 图形准确性-时序图与代码不符 | 严重 | 4 | 3.1 HTTPS请求响应完整流程时序图 | 时序图与实际代码实现不符：<br>1. 第156-157行：add_listen_fd的调用存在疑问<br>2. 第174-175行：Event.handler直接调用get_protocol_handler()和on_read()，但实际代码中handler是封装过的<br>3. 缺少Callback处理和DebugChain处理的完整流程 | 1. 对照实际代码修正时序图<br>2. 补充完整的Callback执行流程<br>3. 补充完整的DebugChain处理流程<br>4. 移除图中的问号和注释疑问 |
| LT-008 | 落地可行性-缺少错误处理联调约定 | 一般 | 3 | 全文 | 模块联调缺少错误处理约定：<br>1. 未明确模块间错误码的传递和转换规则<br>2. 未明确异常情况下的资源清理责任（如Connection创建失败时谁负责close fd）<br>3. 未明确超时场景下的模块协作机制 | 1. 新增"模块间错误处理约定"章节<br>2. 明确错误码传递规则和转换规则<br>3. 明确异常场景下的资源清理责任边界 |
| LT-009 | 落地可行性-缺少线程安全约定 | 一般 | 3 | 全文 | 模块联调缺少线程安全约定：<br>1. 未明确哪些接口是线程安全的<br>2. 未明确跨模块调用时的锁策略（如ConnectionManager的方法是否内部加锁）<br>3. 未明确shared_ptr/weak_ptr的使用约定 | 1. 新增"线程安全约定"章节<br>2. 明确各模块接口的线程安全保证<br>3. 明确跨模块对象生命周期管理的智能指针使用约定 |
| LT-010 | 文档清晰度-缺少与现有集成测试的对照 | 一般 | 2 | 7. 联调测试用例 | 测试用例章节与现有集成测试不符：<br>1. 7.1节列出的Integration_UseCase013-020在实际test_event_flow.cpp中存在<br>2. 但缺少test_server_startup.cpp和test_connection_manager.cpp的用例映射<br>3. 测试用例描述过简，无具体输入输出 | 1. 对照codes/core/test/integration_tests/下的实际测试文件更新7.1节<br>2. 补充test_server_startup.cpp和test_connection_manager.cpp的用例映射<br>3. 细化测试用例的输入参数和期望输出描述 |
| LT-011 | 落地可行性-Checklist缺少验证方法细节 | 一般 | 2 | 6.2-6.5 Checklist | Checklist中"验证方法"列描述过简：<br>1. 多数项只写"编写测试调用xxx"，无具体步骤<br>2. 缺少明确的成功判定标准<br>3. 缺少异常场景的Checklist项 | 1. 细化每个检查项的验证步骤<br>2. 明确每个检查项的成功判定标准<br>3. 补充异常场景（如配置无效、端口占用等）的Checklist项 |
| LT-012 | 文档清晰度-数据结构定义不完整 | 一般 | 1 | 5. 数据结构传递约定 | 数据结构约定不完整：<br>1. Event对象的定义（5.2节）与msg_center模块的实际event.hpp可能不符<br>2. 缺少ConnectionState枚举的完整定义<br>3. 缺少CertConfig、TlsConfig等配置结构体的传递约定 | 1. 对照实际代码修正Event对象定义<br>2. 补充ConnectionState枚举定义<br>3. 补充配置结构体在模块间的传递约定 |

---

## 整体评价

### 合规项
1. 文档结构完整，包含了依赖关系、交互流程、接口契约、Checklist、测试用例等核心章节
2. 2.1依赖关系图基本符合架构设计文档的模块划分
3. 5.4错误码约定与架构设计保持一致
4. 6.1联调阶段划分合理，从基础到高级循序渐进

### 待改进项
1. **核心待改进项1（架构一致性）**：与现有代码实现存在多处不一致，需对照codes/core/下的实际代码修正初始化顺序、接口契约、时序图
2. **核心待改进项2（落地可行性）**：缺少Callback和DebugChain两大核心模块的联调内容，需补充完整
3. **核心待改进项3（文档清晰度）**：存在多处"待确认"、问号等未解决疑问，需明确后移除
4. **核心待改进项4（落地可行性）**：缺少线程安全、错误处理等关键联调约定

### 落地性评估
修正所有问题后，文档可用于指导联调工作，但建议在修改完成后进行二次检视，重点验证：
1. 与现有代码实现的一致性
2. Callback和DebugChain模块联调内容的完整性
3. 未解决疑问的清除情况

---

## 修改建议总纲

### 修改优先级
1. **致命问题优先（LT-001、LT-002）**：修正与代码实现不一致的内容，这是联调的基础
2. **严重问题其次（LT-003至LT-007）**：清除未解决疑问，补充Callback和DebugChain模块内容，修正时序图
3. **一般问题最后（LT-008至LT-012）**：补充错误处理、线程安全约定，完善Checklist和测试用例

### 修改核心方向
1. **架构一致性维度**：以现有代码实现（codes/core/）为唯一基准，修正初始化顺序、接口契约、时序图
2. **落地可行性维度**：补充Callback和DebugChain模块的完整联调内容，新增线程安全和错误处理约定
3. **文档清晰度维度**：清除所有"待确认"、问号，新增模块间接口汇总表
4. **图形准确性维度**：对照代码修正时序图，补充Callback和DebugChain的交互流程

### 二次检视提示
修改完成后，需重点检视：
1. 所有与代码实现相关的描述是否一致
2. Callback和DebugChain模块的联调内容是否完整
3. 所有未解决疑问是否已清除
4. 时序图是否准确反映实际代码流程

---

**文档结束**
