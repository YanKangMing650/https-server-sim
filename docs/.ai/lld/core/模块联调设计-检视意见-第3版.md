# 模块联调设计 - 检视意见

**版本**: v3
**检视日期**: 2026-02-20
**初始得分**: 75分

---

## 一、问题点汇总

| 序号 | 问题类型 | 问题位置 | 问题描述 | 扣分 |
|-----|---------|---------|---------|------|
| 1 | 与实际代码不一致 | 5.3节 Server与ConnectionManager的接口契约 | 代码中handle_accept不是由Server直接实现，而是通过MsgCenter的事件handler机制；set_client_info等调用流程未体现 | 5 |
| 2 | 与实际代码不一致 | 3.1节 HTTPS请求响应完整时序图 | 时序图中DebugChain的调用位置、Callback调用位置与实际代码架构不符 | 5 |
| 3 | 过度设计 | 9.7节 阶段7高级功能联调 | HTTP/2、国密支持等功能当前代码未实现，列入Checklist为时尚早 | 3 |
| 4 | 不清晰/遗漏 | 4.节 模块间接口汇总表 | 缺少Server::graceful_shutdown相关接口、ConnectionManager::check_callback_timeouts等实际存在的接口 | 4 |
| 5 | 与实际代码不一致 | 7.1节 错误码统一约定 | Server模块实际错误码（ERR_INVALID_STATE=-1等）与表中定义不一致 | 3 |
| 6 | 不清晰/遗漏 | 5.7节 WorkerPool与Callback接口契约 | 未明确Callback任务完成后如何通过Event通知EventLoop（CALLBACK_DONE事件） | 4 |
| 7 | 不清晰/遗漏 | 2.3节 初始化顺序 | 缺少ProtocolHandler初始化、DebugChain初始化、CallbackStrategy初始化的顺序约定 | 3 |
| 8 | 不清晰 | 8.3节 跨模块调用锁策略 | 锁获取顺序约定（Server→ConnectionManager→Connection）在实际代码中未明确体现，可能产生死锁风险 | 3 |
| 9 | 与实际代码不一致 | 10.1节 集成测试用例映射 | 缺少UseCase011、UseCase012的映射，且序号不连续 | 2 |
| 10 | 不清晰 | 6.4节 ConnectionState枚举 | ACCEPTING状态的实际使用场景不清晰（代码中初始状态是ACCEPTING，但文档中流程从TLS_HANDSHAKING开始） | 3 |

---

## 二、扣分详情

| 问题类型 | 数量 | 累计扣分 |
|---------|------|---------|
| 与实际代码不一致 | 4 | 16分 |
| 不清晰/遗漏 | 4 | 14分 |
| 过度设计 | 1 | 3分 |
| **总计** | **10** | **25分** |

---

## 三、具体问题描述

### 问题1：Server与ConnectionManager的接口契约与实际代码不一致
- **位置**: 5.3节
- **当前描述**: 文档给出了`handle_accept()`伪代码，暗示由Server直接实现
- **问题**: 实际代码中，ACCEPT事件handler的注册和实现是在MsgCenter层面，Server通过回调机制处理
- **建议**: 按实际代码重构这部分契约，体现Event + handler机制

### 问题2：HTTPS请求响应时序图与实际架构不符
- **位置**: 3.1节 mermaid时序图
- **当前描述**: 图中显示EL->DC调用process_request，WP->DC调用process_response
- **问题**: 实际代码中这些模块的交互链路尚未明确，DebugChain与ProtocolHandler的协作关系不清晰
- **建议**: 时序图应基于已实现代码绘制，未实现部分标注为"设计中"

### 问题3：阶段7高级功能联调属于过度设计
- **位置**: 9.7节
- **当前描述**: 包含HTTP/2、国密支持等联调项
- **问题**: 这些功能在当前代码库中未实现，联调Checklist应聚焦已实现功能
- **建议**: 移除阶段7或标记为"待实现"

### 问题4：模块间接口汇总表有遗漏
- **位置**: 4.节
- **问题**: 缺少以下实际存在的接口：
  - Server::graceful_shutdown()
  - ConnectionManager::check_callback_timeouts()
  - Connection::set_client_info()
- **建议**: 补充这些接口到汇总表

### 问题5：错误码定义与实际代码不一致
- **位置**: 7.1节
- **当前描述**: Server错误码定义为ERR_CONFIG_LOAD=-1001等
- **问题**: 实际代码中server.hpp定义的是：
  ```cpp
  ERR_CONFIG_LOAD = -2
  ERR_CONFIG_VALIDATE = -3
  ```
- **建议**: 按实际代码修正错误码表

### 问题6：Callback任务完成后的事件通知机制不清晰
- **位置**: 5.7节
- **问题**: 未明确WorkerPool执行完Callback后，如何通过CALLBACK_DONE事件通知EventLoop继续处理
- **建议**: 补充这部分接口契约

### 问题7：初始化顺序不完整
- **位置**: 2.3节
- **问题**: 仅说明了Server、Config、ConnectionManager、MsgCenter的初始化顺序，缺少：
  - ProtocolHandler何时初始化、如何关联到Connection
  - DebugChain何时初始化、注册Handler
  - CallbackStrategyManager何时注册回调
- **建议**: 补充完整初始化链路

### 问题8：跨模块调用锁策略不清晰
- **位置**: 8.3节
- **当前描述**: 规定锁获取顺序为Server→ConnectionManager→Connection
- **问题**: 实际代码中未明确体现这一顺序，若反向获取可能产生死锁
- **建议**: 明确在哪些场景需要按此顺序获取锁，或简化锁策略

### 问题9：集成测试用例映射不完整
- **位置**: 10.1节
- **问题**: 用例ID从UseCase010直接跳到UseCase013，缺少011、012
- **建议**: 检查实际测试文件，补充完整映射

### 问题10：ConnectionState枚举使用不清晰
- **位置**: 6.4节
- **当前描述**: ACCEPTING=1表示"新接受连接，等待TLS握手"
- **问题**: 时序图中流程从TLS_HANDSHAKING开始，未体现ACCEPTING状态的使用
- **建议**: 明确ACCEPTING状态在何时设置、何时转换到TLS_HANDSHAKING

---

## 四、修改优先级

| 优先级 | 问题序号 | 修改内容 |
|-------|---------|---------|
| 高 | 1, 2, 5 | 修正与实际代码不一致的部分 |
| 中 | 4, 6, 7 | 补充遗漏的接口和流程 |
| 低 | 3, 8, 9, 10 | 优化过度设计和不清晰点 |

---

## 五、总体评价

本文档结构完整、覆盖面广，核心交互流程梳理清晰，Checklist和测试用例部分很有参考价值。主要问题在于部分内容与实际代码实现存在偏差，以及少量过度设计。修正上述问题后，得分可提升至90分以上。

