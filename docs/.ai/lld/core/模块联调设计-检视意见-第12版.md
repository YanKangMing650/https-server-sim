# 模块联调设计 - 检视意见（第12版）

**文档版本**: v12
**检视日期**: 2026-02-20
**检视范围**: `docs/design/lld-模块联调设计.md`

---

## 一、总体评分

| 检视维度 | 满分 | 得分 | 扣分说明 |
|---------|------|------|---------|
| 架构一致性 | 30分 | **22分** | 存在接口定义与代码不一致、部分设计内容代码中未实现 |
| 落地可行性 | 30分 | **21分** | 部分接口契约描述模糊、缺少关键实现细节 |
| 文档清晰度 | 25分 | **20分** | 部分描述前后不一致、术语使用需进一步统一 |
| 图形准确性 | 15分 | **13分** | 时序图部分交互与实际代码存在偏差 |
| **总分** | **100分** | **76分** | - |

---

## 二、问题清单（按严重程度排序）

### 严重问题

| 序号 | 问题位置 | 问题描述 | 扣分依据 |
|------|---------|---------|---------|
| **1** | 5.3节 Server与ConnectionManager的接口契约 | 文档描述`Server::start()`中会注册ACCEPT handler到MsgCenter，且定义了`handle_accept()`方法，但实际代码（server.hpp/server.cpp）中不存在该方法，也没有注册handler的逻辑 | 与实际代码不一致，架构一致性 -5分 |
| **2** | 5.3节 Server::handle_accept()示例代码 | 示例代码中使用了`create_protocol_handler()`、`convert_cert_config()`、`convert_tls_config()`等函数，但这些函数在现有代码库中不存在 | 与实际代码不一致，架构一致性 -3分 |

---

### 一般问题

| 序号 | 问题位置 | 问题描述 | 扣分依据 |
|------|---------|---------|---------|
| **3** | 4.1节 模块间接口汇总表 | `Connection::transition_to()`返回值标注为"ConnectionState"，但实际代码（connection.hpp第110行）中返回值为`void` | 接口定义错误，文档清晰度 -2分 |
| **4** | 3.1节 时序图 | 时序图展示Server调用`MsgCenter::add_listen_fd(fd, port)`时注册handler，但实际代码（msg_center.hpp第84行）中`add_listen_fd()`仅接受fd和port两个参数，无handler参数 | 图形与代码不一致，图形准确性 -2分 |
| **5** | 5.4节 配置转换函数 | 文档详细定义了`convert_cert_config()`和`convert_tls_config()`函数，但这些函数在现有代码中不存在 | 与实际代码不一致，落地可行性 -3分 |
| **6** | 6.5节 配置结构体传递约定 | 配置转换缺少明确的实现位置、调用时机、错误处理策略的详细说明 | 缺少落地细节，落地可行性 -3分 |

---

### 不清晰点

| 序号 | 问题位置 | 问题描述 | 扣分依据 |
|------|---------|---------|---------|
| **7** | 2.3节、3.2节 ProtocolHandler初始化 | 未明确说明由谁负责创建Http1Handler/Http2Handler（Server？ConnectionManager？） | 责任方不明确，文档清晰度 -1分 |
| **8** | 3.3节 事件处理机制 | 说明"IoThread检测IO事件，创建Event并设置handler（Server注册的函数）"，但未明确Server如何注册handler、handler的具体类型和签名 | 机制不清晰，文档清晰度 -1分 |
| **9** | 9.4节 阶段3 Checklist | 检查项标注为"部分实现"，但未明确说明哪些部分已实现、哪些未实现 | 描述模糊，文档清晰度 -1分 |

---

## 三、详细检视意见

### 1. 架构一致性检视（30分 → 22分，扣8分）

#### 1.1 与现有代码实现的一致性

| 检查项 | 文档内容 | 代码实际情况 | 判定 |
|--------|---------|-------------|------|
| Server::init()流程 | 文档2.3节、3.2节描述准确 | server.cpp第35-80行实现一致 | ✓ 一致 |
| Server::start()流程 | 文档描述先启动MsgCenter再add_listen_fd | server.cpp第82-142行实现一致 | ✓ 一致 |
| ConnectionManager::create_connection() | 参数int fd, uint16_t server_port | connection_manager.hpp第35行一致 | ✓ 一致 |
| Connection::transition_to() | 返回ConnectionState | connection.hpp第110行返回void | ✗ 不一致 |
| MsgCenter::add_listen_fd() | 隐含handler参数 | msg_center.hpp第84行仅fd, port | ✗ 不一致 |
| Server::handle_accept() | 文档有完整定义 | server.hpp中不存在 | ✗ 不一致 |
| 配置转换函数 | 文档有完整定义 | 代码库中不存在 | ✗ 不一致 |

**扣分原因**: 4处接口定义与代码不一致，扣8分

#### 1.2 与架构设计的一致性

整体符合架构设计文档的分层架构、模块划分、接口定义原则，未发现重大架构偏差。

---

### 2. 落地可行性检视（30分 → 21分，扣9分）

#### 2.1 接口契约清晰度

| 接口 | 文档描述 | 是否可落地 |
|------|---------|-----------|
| Server::init() / start() | 清晰，有伪代码 | ✓ 可落地 |
| ConnectionManager::create_connection() | 清晰 | ✓ 可落地 |
| Connection::set_protocol_handler() | 清晰 | ✓ 可落地 |
| ProtocolHandler::init() | 清晰 | ✓ 可落地 |
| **配置转换** | **缺少实现位置、调用时机** | ✗ **需补充** |
| **ProtocolHandler创建** | **责任方不明确** | ✗ **需补充** |
| **事件handler注册** | **机制不清晰** | ✗ **需补充** |

#### 2.2 流程描述明确度

| 流程 | 明确度 | 说明 |
|------|--------|------|
| Server启动流程 | ✓ 明确 | 与代码一致 |
| Connection创建流程 | ✓ 明确 | 描述清晰 |
| **ProtocolHandler初始化流程** | ◐ 部分明确 | 缺少创建责任方 |
| **配置转换流程** | ✗ 不明确 | 函数不存在 |
| 事件处理流程 | ◐ 部分明确 | handler注册机制不清晰 |

**扣分原因**: 3项关键流程缺少落地细节，扣6分；配置转换函数不存在，扣3分

---

### 3. 文档清晰度检视（25分 → 20分，扣5分）

#### 3.1 表述清晰度

| 章节 | 清晰度评价 | 问题 |
|------|-----------|------|
| 2. 模块依赖关系 | ✓ 清晰 | - |
| 3. 核心交互流程 | ◐ 一般 | 时序图与代码有偏差 |
| 4. 模块间接口汇总表 | ◐ 一般 | transition_to()返回值错误 |
| 5. 模块接口契约 | ◐ 一般 | 包含不存在的函数 |
| 6. 数据结构传递约定 | ✓ 清晰 | - |
| 7. 错误处理约定 | ✓ 清晰 | - |
| 8. 线程安全约定 | ✓ 清晰 | - |
| 9. 联调步骤与Checklist | ◐ 一般 | "部分实现"未明确 |
| 10. 联调测试用例 | ✓ 清晰 | - |

#### 3.2 术语统一性

| 术语 | 使用情况 | 评价 |
|------|---------|------|
| Http1Handler / Http2Handler | 一致 | ✓ 统一 |
| ProtocolHandler | 一致 | ✓ 统一 |
| "设计规划"标注 | 部分统一 | ◐ 需改进 |
| "已实现"标注 | 部分统一 | ◐ 需改进 |

**扣分原因**: 2处描述不清晰，扣3分；1处接口错误，扣2分

---

### 4. 图形准确性检视（15分 → 13分，扣2分）

#### 4.1 时序图（3.1节）

| 交互步骤 | 与代码一致性 | 说明 |
|---------|-------------|------|
| Server::init() | ✓ 一致 | - |
| Server::start() | ✓ 一致 | - |
| MsgCenter::start() | ✓ 一致 | - |
| MsgCenter::add_listen_fd() | ✗ 不一致 | 时序图隐含handler参数，代码中无 |
| ConnectionManager::create_connection() | ✓ 一致 | - |
| Connection::set_client_info() | ✓ 一致 | - |
| ProtocolHandler创建/init | ◐ 部分一致 | 代码中未实现 |

#### 4.2 依赖关系图（2.1节）

| 模块关系 | 准确性 | 说明 |
|---------|--------|------|
| Server聚合ConnectionManager | ✓ 准确 | - |
| Server聚合MsgCenter | ✓ 准确 | - |
| ConnectionManager→Connection | ✓ 准确 | - |
| Connection→ProtocolHandler | ✓ 准确 | - |

**扣分原因**: 时序图1处与代码不一致，扣2分

---

## 四、修改建议

### 优先修改（P0）

1. **修正5.3节**：删除或标注`handle_accept()`为设计规划
2. **修正4.1节**：将`Connection::transition_to()`返回值改为`void`
3. **修正3.1节时序图**：移除`add_listen_fd()`的handler参数，或单独标注为设计规划

### 次优先修改（P1）

4. **标注设计规划**：明确标注5.4节配置转换函数为"设计规划"
5. **补充ProtocolHandler创建责任方**：明确说明由谁创建Http1Handler/Http2Handler
6. **补充事件handler注册机制**：说明Server如何注册handler

### 一般优化（P2）

7. **统一"设计规划"标注**：全文统一使用`⚠️ [设计规划]`标记
8. **明确"部分实现"**：对9.4节的"部分实现"进行明细说明
9. **优化依赖图标注**：明确表示聚合关系

---

## 五、代码对照关键文件清单

| 模块 | 头文件路径 | 源文件路径 |
|------|-----------|-----------|
| Server | `codes/core/server/include/server/server.hpp` | `codes/core/server/source/server.cpp` |
| Connection | `codes/core/connection/include/connection/connection.hpp` | `codes/core/connection/source/connection.cpp` |
| ConnectionManager | `codes/core/connection/include/connection/connection_manager.hpp` | `codes/core/connection/source/connection_manager.cpp` |
| MsgCenter | `codes/core/msg_center/include/msg_center/msg_center.hpp` | `codes/core/msg_center/source/msg_center.cpp` |
| ProtocolHandler | `codes/core/protocol/include/protocol/protocol_handler.hpp` | `codes/core/protocol/source/protocol_handler.cpp` |
| Config | `codes/core/config/include/config/config.hpp` | `codes/core/config/source/config.cpp` |
| Event | `codes/core/msg_center/include/msg_center/event.hpp` | - |

---

**检视意见结束**
