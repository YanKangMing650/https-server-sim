# 【详细设计文档检视报告】模块联调设计文档 (v9)

**版本**: v9
**检视日期**: 2026-02-20
**文档路径**: docs/design/lld-模块联调设计.md
**状态**: 正式检视报告

---

## 1. 检视概述

### 1.1 检视模块信息
- **检视模块名称**: 模块联调设计
- **唯一标识**: LLD-INTEG-v9
- **输入文件**:
  - 架构设计文档: `docs/design/hld-架构设计文档.md` (v4)
  - 模块联调设计文档: `docs/design/lld-模块联调设计.md` (v9)
  - 实际代码: `codes/core/` 目录下头文件和源文件

### 1.2 检视范围
- 详细设计文档所有章节 (1-11)
- 所有时序图、依赖图
- 所有接口定义、数据结构
- 所有联调步骤与Checklist

### 1.3 检视依据
1. 架构设计文档 (hld-架构设计文档.md)
2. 现有代码实现 (codes/core/ 目录)
3. 详细设计文档编写规范

### 1.4 评分结果

| 维度 | 满分 | 得分 | 扣分说明 |
|-----|-----|-----|---------|
| 架构一致性 | 30 | 24 | 接口定义有6处与代码不完全一致 |
| 落地可行性 | 30 | 21 | 契约描述存在模糊点，部分流程未明确实现路径 |
| 文档清晰度 | 25 | 22 | 术语基本统一，存在少量表述模糊问题 |
| 图形准确性 | 15 | 12 | 时序图中部分交互在现有代码中无对应实现 |
| **总分** | **100** | **79** | **-21** |

### 1.5 整体结论
整体符合架构约束，文档结构完整，清晰区分了「已实现」和「设计规划」部分。存在 **0处致命问题、3处严重问题、8处一般问题**。修正后可指导开发落地。

---

## 2. 核心问题清单

| 问题 ID | 问题所属维度 | 问题严重程度 | 问题具体位置 | 问题详细描述 | 针对性修改建议 |
|---------|-------------|-------------|-------------|-------------|---------------|
| **INT-001** | 架构一致性 - 接口定义 | 严重 | 4.1 模块间接口汇总表, 序号15 | `Connection::set_protocol_handler()` 在文档中标记为"模块间接口"，但按接口分类标准（435-436行），此方法在Connection模块内部被调用，更准确分类应为"内部接口" | 1. 修正接口类型为"内部接口" 2. 或补充说明该方法在模块间的实际调用场景 |
| **INT-002** | 架构一致性 - 接口定义 | 严重 | 5.4 节, 第668-672行 | 文档中 `ProtocolHandler::on_read()` 和 `on_write()` 被描述为"无参数方法"，这与头文件一致。但文档中同时提到"从read_buffer_读取"，而实际代码中read_buffer_是在init()中通过Connection获取的，该关联未明确 | 补充说明 `ProtocolHandler::init()` 与 `Connection::get_read_buffer()`/`get_write_buffer()` 的调用时机和依赖关系 |
| **INT-003** | 架构一致性 - 数据结构 | 严重 | 6.4 节, 第993-994行 | 文档标注 `PROCESSING` 和 `SENDING` 状态为"✗ 否"未在代码中使用，但connection.hpp中这两个状态已在enum class中定义。状态机的is_valid_state_transition()可能未支持这些状态的转换 | 1. 核实代码中是否支持 PROCESSING / SENDING 状态的合法转换 2. 修正实现状态标记为"◐ 部分" 3. 补充状态转换规则 |
| **INT-004** | 落地可行性 - 契约模糊 | 一般 | 5.3 节, 第595-616行 | `handle_accept()` 示例代码中使用了 `client_ip` 和 `client_port`，但未说明这些值从何而来（实际应从accept()获取对端地址） | 补充 `client_ip` 和 `client_port` 的获取方式说明，或注明该代码片段为示意，需结合实际accept()实现 |
| **INT-005** | 落地可行性 - 配置结构 | 一般 | 6.5 节, 第1046-1048行 | 文档提到 `cert_config` 从 `Config::get_certificates()` 获取（返回 `CertificatesConfig`），但 `ProtocolHandler::init()` 的参数类型是 `CertConfig`。这两个类型名称不一致 | 核实 `protocol_types.hpp` 中的实际类型定义，统一类型名称或说明类型映射关系 |
| **INT-006** | 文档清晰度 - 术语不统一 | 一般 | 多处 | 文档中同时使用 "Http1Handler" / "Http2Handler" 和 "HTTP/1.1" / "HTTP/2"，建议统一命名风格 | 统一术语：代码实现类名用 Http1Handler/Http2Handler，协议名称用 HTTP/1.1、HTTP/2 |
| **INT-007** | 文档清晰度 - 表述模糊 | 一般 | 3.1 节, 第337行 | "send_response() 接口已在基类中定义（纯虚函数），但 Http1Handler 和 Http2Handler 的具体实现可能不完整" —— "可能不完整"表述模糊，建议明确说明实现状态 | 1. 查阅 protocol_handler.cpp 核实实现状态 2. 明确标注为"✗ 未实现"或"◐ 部分实现" |
| **INT-008** | 图形准确性 - 时序图 | 一般 | 3.1 节时序图, 第237-239行 | 时序图中有两个连续的 `deactivate EL`，这在Mermaid语法中不影响渲染，但属于冗余 | 删除多余的 `deactivate EL`（第239行） |
| **INT-009** | 图形准确性 - 交互缺失 | 一般 | 3.1 节时序图, 第253-262行 | 时序图显示 `EL->Conn: get_protocol_handler()` 后立即调用 `Proto: on_read()`，但实际代码中在TLS握手阶段还有 `TlsHandler::continue_handshake()` 的具体逻辑未体现 | 在时序图中补充或明确标注"⚡ TLS握手逻辑详见ProtocolHandler实现" |
| **INT-010** | 落地可行性 - 测试用例 | 一般 | 9.2 节 Checklist 1.8 | Checklist 1.8 标注"✗ 未实现"（Event优先级处理），但代码中EventQueue已支持优先级。建议核实 | 核实 EventQueue 的优先级实现，如已实现则修正标记为"✓ 已实现" |
| **INT-011** | 架构一致性 - 命名空间 | 一般 | 2.1 依赖关系图 | 图中标注 `https_server_sim::ConnectionManager`，但实际代码中 `ConnectionManager` 是在 `https_server_sim` 命名空间下（非子命名空间），这与代码一致。但第79行标注 `https_server_simConnectionManager` 缺少分隔符 | 修正第79行的命名空间标注为 `https_server_sim::ConnectionManager` |

---

## 3. 整体评价

### 3.1 合规项
1. **架构一致性**: 文档严格区分"已实现"和"设计规划"，架构边界清晰
2. **落地可行性**: 模块接口汇总表（4.1节）与实际代码高度一致
3. **文档清晰度**: 章节结构完整，Checklist和测试用例具体可执行
4. **图形准确性**: 时序图整体逻辑正确，正确标识了设计规划部分

### 3.2 待改进项
- **架构一致性**: 重点修正 3 处严重问题，统一数据结构名称和接口分类
- **落地可行性**: 补充模糊的契约描述，明确配置类型映射
- **文档清晰度**: 消除不确定表述（"可能"），明确实现状态
- **图形准确性**: 优化时序图细节，确保与代码实现一致

### 3.3 落地性评估
**修正所有问题后，文档可直接指导开发落地**。当前文档主体质量较高，仅需对细节进行校准。

---

## 4. 修改建议总纲

### 4.1 修改优先级
1. **严重问题优先**: INT-001, INT-002, INT-003
2. **一般问题**: INT-004 ~ INT-011

### 4.2 修改核心方向
| 维度 | 修改重点 |
|-----|---------|
| **架构一致性** | 1. 修正接口分类 2. 统一配置类型名称 3. 明确状态机实现状态 |
| **落地可行性** | 1. 补充契约中的参数来源说明 2. 明确 ProtocolHandler 初始化流程 3. 完善测试用例状态 |
| **文档清晰度** | 1. 统一术语 2. 消除模糊表述 3. 明确标注实现状态 |
| **图形准确性** | 1. 修正时序图冗余 2. 补充交互说明 |

### 4.3 二次检视提示
修改完成后，建议重点检视：
1. **接口分类一致性**: 确保所有接口分类符合4.1节的标准
2. **配置类型映射**: 确保 CertConfig/CertificatesConfig 的关系明确
3. **状态机定义**: 确保 PROCESSING/SENDING 状态的转换规则清晰

---

## 附录：关键代码对照速查表

| 文档位置 | 代码文件 | 验证点 |
|---------|---------|-------|
| 5.4节 ProtocolHandler::init() | `protocol_handler.hpp` 第43-45行 | 参数类型: CertConfig, TlsConfig |
| 6.4节 ConnectionState | `connection.hpp` 第26-35行 | 枚举值定义: PROCESSING=5, SENDING=6 |
| 4.1节 MsgCenter::add_listen_fd() | `msg_center.hpp` 第84行 | 双参数版本: (int fd, uint16_t port) |
| 5.2节 Server::start() | `server.hpp` 第98行 | 返回值: int |

---

**文档结束**

**检视报告生成时间**: 2026-02-20
**检视报告版本**: v1.0
