# 【模块联调设计文档】检视意见 - 第4版

**文档名称**: lld-模块联调设计.md
**版本**: v4
**检视日期**: 2026-02-20
**评分**: 78/100

---

## 评分明细

| 维度 | 满分 | 得分 | 扣分说明 |
|-----|-----|-----|---------|
| 架构一致性 | 30 | 22 | -8 分：多处与实际代码不一致 |
| 落地可行性 | 30 | 23 | -7 分：部分流程描述不清晰 |
| 文档清晰度 | 25 | 20 | -5 分：部分细节模糊 |
| 图形准确性 | 15 | 13 | -2 分：时序图与代码有出入 |
| **总分** | **100** | **78** | **-22 分** |

---

## 问题清单（按严重程度排序）

### 严重问题

| 序号 | 问题位置 | 问题描述 | 扣分 | 修改建议 |
|-----|---------|---------|-----|---------|
| 1 | 3.1节 时序图 | Event结构定义与实际代码不一致。文档中Event包含`port`字段，但实际`event.hpp`中没有`port`字段，有`user_data`字段 | 4 | 修正Event结构定义，与`codes/core/msg_center/include/msg_center/event.hpp`保持一致 |
| 2 | 4.节 模块间接口汇总表 | 接口表中多处方法名、参数与实际代码不符。例如：Config没有单独的`validate()`公开方法供Server调用（validate是内部调用的） | 3 | 对照实际代码头文件，梳理并修正接口汇总表 |
| 3 | 5.7节 WorkerPool与Callback契约 | 示例代码中WorkerPool任务直接调用`ProtocolHandler::send_response()`，但实际应该由EventLoop的CALLBACK_DONE handler来执行 | 3 | 修正契约描述，明确WorkerPool只负责post CALLBACK_DONE事件，不直接调用ProtocolHandler |

### 一般问题

| 序号 | 问题位置 | 问题描述 | 扣分 | 修改建议 |
|-----|---------|---------|-----|---------|
| 4 | 2.1节 依赖关系图 | Callback模块在图中标注为"Callback Strategy Manager"，但其他地方称为"Callback"，命名不统一 | 1 | 统一模块命名 |
| 5 | 2.3节 初始化顺序 | 描述DebugChain和CallbackStrategy初始化由Server负责，但Server.hpp中没有相关成员或方法 | 2 | 补充说明这些模块实际由谁初始化（或说明是外部初始化后注入） |
| 6 | 3.1节 时序图 | 图中标注了`EL->DC: process_request()`，但实际代码中ProtocolHandler才是与DebugChain交互的角色 | 2 | 修正时序图，将DebugChain交互方改为ProtocolHandler |
| 7 | 5.3节 Server与ConnectionManager契约 | 示例代码中`create_protocol_handler()`的调用位置和方式不明确，代码中未体现该函数来源 | 1 | 补充说明`create_protocol_handler`是Server的方法还是外部函数 |
| 8 | 5.6节 ProtocolHandler与DebugChain契约 | 契约示例代码中DebugChain返回值为`ERR_STOP_CHAIN`，但实际错误码定义需要确认 | 1 | 对照DebugChain实际代码确认返回值常量名称 |
| 9 | 7.1节 错误码表 | 错误码混合使用宏（ERR_SUCCESS）和枚举（ServerError），与实际代码不完全一致 | 1 | 统一错误码表述方式，区分枚举和宏 |
| 10 | 8.1节 线程安全表 | 部分方法的线程安全标注与实际代码实现可能有出入（如Buffer相关） | 1 | 对照实际代码确认各方法的线程安全保证 |
| 11 | 10.1节 用例映射表 | Integration_UseCase011和012标注为"待补充"，与实际测试文件不完全对应 | 1 | 补充或移除"待补充"项，与实际测试文件保持一致 |
| 12 | 10.5-10.6节 测试用例 | DebugChain和Callback的测试用例没有对应的实际集成测试文件 | 2 | 说明这些是规划中的测试，或补充实际测试 |

### 不清晰点

| 序号 | 问题位置 | 不清晰描述 | 建议 |
|-----|---------|----------|------|
| 13 | 2.2节 依赖层级 | L2层级同时包含ConnectionManager和Connection，但Connection从属于ConnectionManager | 建议进一步明确父子模块关系 |
| 14 | 3.1节 时序图 | CALLBACK_DONE事件的handler具体是在何处注册的不清晰 | 补充说明CALLBACK_DONE handler的注册位置 |
| 15 | 5.8节 CALLBACK_DONE机制 | `handle_callback_done_in_event_loop()`的实现方不明确（哪个类的方法？） | 明确该函数的归属模块 |
| 16 | 6.4节 ConnectionState | RECEIVING状态的转换时机描述不够清晰 | 补充RECEIVING状态在什么条件下进入和退出 |
| 17 | 9.1节 联调阶段 | 阶段划分中没有明确各阶段的入口准则和出口准则 | 补充各阶段的准出条件 |

### 过度设计点

| 序号 | 问题位置 | 过度设计描述 | 建议 |
|-----|---------|------------|------|
| 18 | 全文档 | 部分伪代码示例过于详细（如5.1、5.2节的Server代码），与实际代码几乎重复 | 建议简化伪代码，只保留核心交互逻辑，不必展示完整实现 |
| 19 | 9.节 Checklist | Checklist中包含"状态"列，但该列在文档中永远是"☐"，实际意义不大 | 建议移除状态列，或改为由测试报告填写 |

---

## 修改优先级

1. **高优先级**（修正代码不一致问题）：问题1、2、3、6
2. **中优先级**（修正不清晰描述）：问题5、14、15、16
3. **低优先级**（格式和优化）：问题4、7-13、17-19

---

## 总体评价

本文档结构完整，覆盖了模块联调所需的核心内容，包括依赖关系、交互流程、接口契约、线程安全约定等。文档的**Checklist设计**是亮点，能有效指导联调工作。

主要问题在于**与实际代码的一致性**需加强，部分时序图和接口描述需要对照现有代码进行修正。修正后可作为联调工作的有效指导文档。
