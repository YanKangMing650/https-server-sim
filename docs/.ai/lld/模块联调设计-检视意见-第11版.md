# 【详细设计文档检视报告】模块联调设计

**检视模块名称**: 模块联调设计
**文档版本**: v11
**检视日期**: 2026-02-20
**检视依据**: 现有代码实现、架构设计文档、各模块详细设计文档

---

## 1. 检视概述

### 1.1 检视模块信息
- **模块名称**: 模块联调设计
- **唯一标识**: LLD-INTEGRATION-v11
- **输入文件**:
  - 架构设计文档: `docs/design/hld-架构设计文档.md`
  - 模块联调设计文档: `docs/design/lld-模块联调设计.md`
  - 代码实现: `codes/core/` 目录下头文件和源文件

### 1.2 检视范围
- 详细设计文档所有章节（1-11章及附录）
- 所有图形（依赖关系图、时序图）
- 所有设计逻辑、接口定义、数据结构约定
- 联调步骤与测试用例

### 1.3 检视依据
1. 现有代码实现（`codes/core/` 目录下头文件）
2. 架构设计文档（`docs/design/hld-架构设计文档.md`）
3. 模块详细设计文档（`docs/design/lld-详细设计文档-*.md`）

### 1.4 评分结果

| 检视维度 | 满分 | 得分 | 扣分说明 |
|---------|------|------|---------|
| 架构一致性 | 30分 | 24分 | 存在接口分类不准确、命名空间不统一等问题 |
| 落地可行性 | 30分 | 22分 | 关键流程缺失实现细节、部分接口契约不明确 |
| 文档清晰度 | 25分 | 20分 | 存在术语不一致、部分描述模糊 |
| 图形准确性 | 15分 | 12分 | 时序图与实际代码有偏差 |
| **总分** | **100分** | **78分** | - |

### 1.5 整体结论
文档整体架构一致性较好，与现有代码实现基本吻合，清晰区分了"已实现"和"设计规划"内容。但存在接口分类不准确、关键流程细节缺失、部分术语不统一等问题。整体符合架构约束，存在**2处严重问题、8处一般问题、3处不清晰点**，无致命问题。

---

## 2. 核心问题清单

| 问题 ID | 问题所属维度 | 问题严重程度 | 问题具体位置 | 问题详细描述 | 针对性修改建议 |
|---------|-------------|-------------|-------------|-------------|---------------|
| **JZ-SJ-001** | 架构一致性 - 接口分类 | 严重 | 4.1 已实现接口汇总表 | 接口分类标准定义模糊，部分接口被错误分类。例如：`ConnectionManager::for_each_connection()`、`get_connection_count()` 被标注为"模块间接口"，但实际这些方法主要供 ConnectionManager 内部或 Server 内部使用，属于内部管理接口。 | 1. 重新明确"模块间接口"定义：跨模块边界且被外部模块主动调用的public方法；2. 将 `for_each_connection()`、`get_connection_count()`、`check_timeouts()` 等重新归类为"内部管理接口"；3. 补充接口调用方清单说明。 |
| **JZ-SJ-002** | 落地可行性 - 流程描述 | 严重 | 5.3 节 handle_accept() 设计示意代码 | 缺少 ACCEPT handler 在 Server 中的实际注册方式和位置说明。文档标注"实际注册方式详见Server模块实现"，但未提供具体信息，且 Server 头文件中也无相关注册接口。 | 1. 明确 ACCEPT handler 的注册位置（Server::start() 中）；2. 补充 Server 向 MsgCenter 注册 handler 的具体接口设计；3. 说明 handler 捕获的上下文变量（如 ConnectionManager 指针）。 |
| **JZ-SJ-003** | 架构一致性 - 命名空间 | 一般 | 全文多处 | 命名空间使用不统一。文档中同时使用 `https_server_sim::ConnectionManager` 和 `https_server_sim::` 下的其他类，但实际代码中 ConnectionManager 无独立命名空间，Server 在 `https_server_sim::server::` 命名空间下。 | 1. 统一命名空间：`https_server_sim::server::Server`、`https_server_sim::ConnectionManager`、`https_server_sim::Connection`、`https_server_sim::protocol::ProtocolHandler`；2. 检查并修正全文所有命名空间引用。 |
| **JZ-SJ-004** | 落地可行性 - 接口契约 | 一般 | 5.4 节 ProtocolHandler::init() | `ProtocolHandler::init()` 的调用方和时机描述不清晰。文档说明由 Server 的 ACCEPT handler 创建并初始化，但未说明 `cert_config` 和 `tls_config` 具体如何从 Config 转换而来（虽然后续 6.5 节有补充，但位置分散）。 | 1. 将配置转换逻辑与 init() 调用放在同一节描述；2. 明确 init() 的返回值处理逻辑（失败时如何清理）；3. 补充调用时序图片段。 |
| **JZ-SJ-005** | 图形准确性 - 时序图 | 一般 | 3.1 节 HTTPS请求响应完整时序图 | 时序图中部分交互与实际代码不符：<br/>1. 图中显示 `EL->CM: create_connection(fd, port)`，但 create_connection 参数应为 `(int fd, uint16_t server_port)`；<br/>2. 图中 ProtocolHandler 的创建位置不明确；<br/>3. READ/WRITE 事件的 handler 设置过程未展示。 | 1. 修正 create_connection 的参数标注；<br/>2. 在 ACCEPT 处理分支中明确 ProtocolHandler 的创建和 init() 调用；<br/>3. 补充 IoThread 如何设置 Event.handler 的说明。 |
| **JZ-SJ-006** | 文档清晰度 - 术语统一 | 一般 | 全文多处 | 术语使用不统一：<br/>1. "Http1Handler" vs "HTTP/1.1处理器"；<br/>2. "回调策略" vs "Callback Strategy"；<br/>3. "调测链" vs "DebugChain"。 | 建立术语对照表，统一全文术语：优先使用代码中的类名（Http1Handler），协议名称使用 HTTP/1.1、HTTP/2。 |
| **JZ-SJ-007** | 落地可行性 - 数据结构 | 一般 | 6.5 节配置结构体传递约定 | `convert_cert_config()` 函数中使用了 `dst.use_gmssl` 字段（第1231-1235行），该字段确实存在于 `protocol::CertConfig` 中，但文档 1175-1183 行的字段映射表格中未列出 `use_gmssl` 字段，存在表格与代码不一致。 | 更新 6.5 节的字段映射表格，补充 `use_gmssl` 字段的映射说明，明确其设置逻辑。 |
| **JZ-SJ-008** | 文档清晰度 - 描述模糊 | 一般 | 5.7 节 WorkerPool 与 CallbackRegistry 接口契约 | `request_data` 和 `request_len` 的来源说明模糊（第941-942行），未明确如何从 Connection 的 read_buffer 中获取解析后的请求数据及长度。 | 1. 明确 request_data 是指向 HttpParser 解析后的请求体的指针；2. 说明 request_len 如何获得；3. 补充数据流转的简要说明。 |
| **JZ-SJ-009** | 架构一致性 - 接口定义 | 一般 | 4.1 节接口汇总表 | 接口汇总表中列出了 `Connection::transition_to()` 为"模块间接口"，但实际代码中 `transition_to()` 是无返回值方法，而表格中返回值列标注为 `ConnectionState`，与代码不符。 | 修正接口汇总表，将 `Connection::transition_to()` 的返回值改为 `void`。 |
| **JZ-SJ-010** | 图形准确性 - 依赖关系图 | 一般 | 2.1 节依赖关系图 | 依赖关系图中 Server 直接指向 Callback，MsgCenter 独立于 Server 之外，但实际代码中 Server 聚合 MsgCenter，Callback 是设计规划模块。 | 修正依赖关系图：1. 明确 Server 聚合 MsgCenter；2. 将 Callback 标注为设计规划且与 Server 的关联为规划中；3. 补充 Utils 被所有模块依赖的关系。 |
| **JZ-BQ-001** | 文档清晰度 - 不清晰点 | 不清晰点 | 5.4 节 ProtocolHandler 工厂选择逻辑 | 工厂选择逻辑中提到"基于配置或 ALPN 协商"，但未说明 ALPN 协商在代码中的哪个模块实现、何时实现。 | 补充说明：当前版本简化实现，ALPN 协商将在后续版本中支持，位置在 TlsHandler 中。 |
| **JZ-BQ-002** | 文档清晰度 - 不清晰点 | 不清晰点 | 9.4 节阶段3协议层联调 Checklist | 3.3-3.6 项标注为"◐ 部分实现"，但未明确哪些部分已实现、哪些未实现。 | 补充说明：HttpParser 类已实现（parse_request_line、parse_headers），但 Http1Handler 中调用这些解析器的逻辑尚未完全实现。 |
| **JZ-BQ-003** | 文档清晰度 - 不清晰点 | 不清晰点 | 7.3 节资源清理责任约定 | 表格中"Socket fd (accepted)"的清理者标注为 `Connection::close_fd()`，但 `close_fd()` 是私有方法，外部无法调用。 | 修正为：清理者是 `Connection::close()`（public 方法），内部调用 `close_fd()`。 |

---

## 3. 整体评价

### 3.1 合规项
1. **架构一致性较好**：文档清晰区分"已实现"和"设计规划"内容，避免混淆；模块依赖关系整体符合架构设计。
2. **与代码实现吻合度高**：Event 结构、ConnectionState 枚举、核心接口定义等与实际代码基本一致。
3. **文档结构完整**：包含依赖关系、核心流程、接口契约、数据结构约定、错误处理、联调Checklist等完整章节。
4. **配置转换逻辑详细**：6.5 节提供了完整的 `CertificatesConfig → CertConfig` 转换代码，可直接参考实现。

### 3.2 待改进项
- **架构一致性维度**：重点修正接口分类不准确、命名空间不统一的问题（2处一般问题）。
- **落地可行性维度**：重点补充 ACCEPT handler 注册方式、配置转换与 init() 调用的完整流程（2处严重问题）。
- **文档清晰度维度**：统一术语、明确模糊描述、补充不清晰点的说明（3处一般问题，3处不清晰点）。
- **图形准确性维度**：修正时序图参数、补充缺失的交互步骤（2处一般问题）。

### 3.3 落地性评估
修正所有问题后，文档可直接指导开发落地。特别是 6.5 节的配置转换代码、5.1-5.2 节的 Server 与 Config/MsgCenter 接口契约已足够清晰。建议重点修正严重问题后进行二次检视。

---

## 4. 修改建议总纲

### 4.1 修改优先级
1. **致命问题**：无
2. **严重问题（优先修改）**：
   - JZ-SJ-001：接口分类不准确
   - JZ-SJ-002：ACCEPT handler 注册方式缺失
3. **一般问题（其次修改）**：
   - JZ-SJ-003 至 JZ-SJ-010（共8项）
4. **不清晰点（最后完善）**：
   - JZ-BQ-001 至 JZ-BQ-003（共3项）

### 4.2 修改核心方向
- **架构一致性**：
  - 重新梳理模块间接口分类标准
  - 统一全文命名空间引用
  - 核实接口定义与代码一致性

- **落地可行性**：
  - 补充 ACCEPT handler 完整注册流程
  - 明确 ProtocolHandler 初始化的完整步骤
  - 补充 request_data 来源说明

- **文档清晰度**：
  - 建立统一术语表
  - 完善模糊描述
  - 补充实现状态说明

- **图形准确性**：
  - 修正时序图参数和交互步骤
  - 修正依赖关系图

### 4.3 二次检视提示
修改完成后，需重点检视以下内容：
1. 修正后的接口分类是否准确
2. 补充的 ACCEPT handler 注册流程是否清晰可落地
3. 修正后的时序图是否与文字描述和代码一致
4. 命名空间是否统一

---

## 附录：代码对照检视详情

### A.1 已验证一致的接口（部分清单）
| 接口 | 代码位置 | 验证状态 |
|-----|---------|---------|
| `Server::init(config_file)` | `server.hpp:92` | ✓ 一致 |
| `Server::start()` | `server.hpp:98` | ✓ 一致 |
| `MsgCenter::add_listen_fd(fd, port)` | `msg_center.hpp:84` | ✓ 一致 |
| `ConnectionManager::create_connection(fd, port)` | `connection_manager.hpp:35` | ✓ 一致 |
| `Connection::set_protocol_handler(handler)` | `connection.hpp:163` | ✓ 一致 |
| `ProtocolHandler::on_read()` | `protocol_handler.hpp:51` | ✓ 一致 |
| `Event::make_callback_done_event()` | `event.hpp:67` | ✓ 一致 |

### A.2 数据结构对照验证
| 数据结构 | 代码位置 | 验证状态 |
|---------|---------|---------|
| `ConnectionState` 枚举 | `connection.hpp:26-35` | ✓ 一致 |
| `CertConfig` 结构体 | `protocol_types.hpp:108-118` | ✓ 一致 |
| `TlsConfig` 结构体 | `protocol_types.hpp:121-132` | ✓ 一致 |
| `Event` 结构体 | `event.hpp:42-76` | ✓ 一致 |

---

**文档结束**

**检视报告生成时间**: 2026-02-20
**检视报告版本**: v1
