# 详细设计文档检视报告 - Server模块

| 项目 | 内容 |
|------|------|
| 检视模块 | Server |
| 文档版本 | v6 |
| 检视轮次 | 第3轮 |
| 检视日期 | 2026-02-17 |
| 检视范围 | 架构符合性、设计清晰性、开发落地可行性 |

---

## 1. 检视概述

### 1.1 输入文档
| 文档 | 路径 |
|------|------|
| 架构设计文档 (HLD) | ./docs/design/hld-架构设计文档.md |
| Server模块详细设计文档 (LLD) | ./docs/design/lld-详细设计文档-Server.md |

### 1.2 评分规则
| 级别 | 扣分 |
|------|------|
| 建议级别 | -0.1分 |
| 一般级别 | -1分 |
| 严重级别 | -3分 |
| 致命级别 | -10分 |

---

## 2. 核心问题清单

| 问题ID | 问题级别 | 扣分 | 问题描述 | 修改建议 |
|--------|----------|------|----------|----------|
| SRV-3-001 | 建议 | -0.1 | **cleanup()方法设计不完整**：3.1.2节Server类方法表中定义了cleanup()方法，但在核心逻辑设计中未提供cleanup()的伪代码实现，仅有cleanup_resources()的实现。虽然cleanup_resources()在graceful_shutdown()中调用，但cleanup()作为独立的public方法，其完整逻辑需要明确。 | 补充cleanup()方法的伪代码实现，明确其与graceful_shutdown()的关系与差异。 |
| SRV-3-002 | 建议 | -0.1 | **缺少状态转换完整性检查**：状态图(图4)展示了状态转换，但缺少对"ERROR状态如何退出"的明确处理逻辑说明。虽然有ERROR→STOPPED的转换标注，但未说明cleanup()是否是唯一的退出方式。 | 在3.2节或4.2节补充ERROR状态的处理说明，明确从ERROR状态恢复的途径。 |
| SRV-3-003 | 建议 | -0.1 | **init_listen_sockets()的网络栈兼容性说明不足**：当前设计仅明确使用AF_INET（IPv4），未说明是否支持IPv6（AF_INET6）。虽然架构文档未明确要求，但作为Server模块，建议明确网络栈支持范围。 | 在3.2.4节或4.3节补充说明：当前仅支持IPv4，IPv6支持作为后续扩展，或明确IPv6的支持计划。 |
| SRV-3-004 | 建议 | -0.1 | **ServerStatus.listen_port/listen_ip与多端口监听的关系**：4.3.2节已说明多端口时取第一个端口/IP，但未明确当所有监听socket关闭后（如stop_accepting()执行后），listen_port/listen_ip是否仍保留初始值，还是清空。 | 在4.3.2节补充说明：get_status()返回的listen_port/listen_ip始终为初始配置的第一个端口/IP，与监听socket是否关闭无关。 |
| SRV-3-005 | 一般 | -1 | **init()方法的异常处理与状态回滚策略不明确**：3.2.1节init()伪代码使用了try-catch捕获所有异常并设置status_=ERROR，但未说明：<br>1. 异常发生时已创建的资源（如部分listen socket、Config对象）如何清理<br>2. 进入ERROR状态后，是否允许再次调用init()进行重试<br>3. ERROR状态下调用cleanup()的行为定义 | 补充以下内容：<br>1. 在init()的异常处理中调用cleanup()清理已创建的资源<br>2. 明确ERROR状态下是否允许重新init()<br>3. 明确ERROR状态下cleanup()的行为 |
| SRV-3-006 | 建议 | -0.1 | **start()方法的MsgCenter启动失败回滚不完整**：3.2.2节中，若msg_center_->start()失败，仅设置status_=ERROR和running_=false，但未清理已创建的子模块（ConnectionManager、MsgCenter），也未关闭listen socket。 | 在start()的MsgCenter启动失败分支中，增加资源清理逻辑，或明确说明此时应调用cleanup()来清理资源。 |
| SRV-3-007 | 建议 | -0.1 | **listen()的backlog参数来源说明**：3.2.4节使用`server_config.backlog`作为listen()的backlog参数，但未说明该配置项是否在Config中定义、默认值是多少、有效范围是什么。 | 在3.2.4节或4.2节补充backlog配置项的说明，包括默认值和有效范围。 |

---

## 3. 整体评价

### 3.1 合规项亮点
1. **架构一致性较好**：详细设计严格遵循HLD中Server模块的职责定义，未越界设计
2. **Graceful Shutdown设计完善**：锁粒度细化合理，超时机制明确，资源清理流程完整
3. **图形描述准确**：类图、时序图、状态图与文字描述一致，无明显矛盾
4. **单元测试覆盖较全面**：17个测试用例覆盖正常、异常、边界场景，特别是锁粒度验证用例设计合理
5. **v6版本改进显著**：针对前两轮检视的问题已全面修复，包括：
   - 补充了close_all_connections()、cleanup_resources()的完整伪代码
   - 明确了数据结构头文件位置
   - 完善了"请求完成"判断条件的设计假设说明
   - 引入了MAX_CONN_CLOSE_WAIT_SECONDS具名常量

### 3.2 待改进项
| 维度 | 问题数量 | 核心改进方向 |
|------|----------|--------------|
| 落地可行性 | 1个一般+6个建议 | 完善异常处理与资源回滚策略 |
| 设计清晰性 | 7个建议 | 补充边界场景的行为说明 |

### 3.3 落地性评估
**结论：修正后可直接指导开发落地**

当前文档v6版本已解决前两轮检视发现的所有严重问题，剩余问题均为建议级别或1个一般级别问题，不影响主体开发落地。修正上述问题后，文档可直接用于编码。

---

## 4. 修改建议总纲

### 4.1 修改优先级
| 优先级 | 问题ID | 说明 |
|--------|--------|------|
| P1（高） | SRV-3-005 | 异常处理与资源回滚策略不明确，影响鲁棒性 |
| P2（中） | SRV-3-006 | start()失败回滚不完整 |
| P3（低） | SRV-3-001, SRV-3-002, SRV-3-003, SRV-3-004, SRV-3-007 | 文档完善性优化 |

### 4.2 二次检视提示
修改完成后，建议重点检视：
1. 异常处理路径的资源清理逻辑是否完整
2. 状态机边界条件的定义是否清晰

---

## 5. 评分结果

| 项目 | 分值 |
|------|------|
| 满分 | 100 |
| 致命问题扣分 | 0 |
| 严重问题扣分 | 0 |
| 一般问题扣分 | -1 |
| 建议问题扣分 | -0.7 |
| **最终得分** | **98.3** |

---

**报告结束**
