# C++代码检视报告

## 概览
- 检视范围：protocol模块（config_converter.hpp/cpp、protocol_handler_factory.hpp/cpp、protocol_types.hpp、CMakeLists.txt、test_protocol.cpp）
- 检视时间：2026-02-21
- 问题统计：严重0个，重要1个，一般3个，建议3个

---

## 问题详情

### 重要问题

1. **[config_converter.cpp:31-32] 国密证书路径未映射 - 功能不完整**
   - 问题描述：ConfigConverter::convert_cert_config只设置了use_gmssl标志，但sm2_cert_path和sm2_key_path没有映射到CertConfig。虽然CertConfig结构中暂未定义这些字段，但这导致国密功能无法真正使用。
   - 严重程度：重要（扣3分）
   - 建议：在CertConfig中增加sm2_cert_path、sm2_key_path字段，并在convert_cert_config中完成映射。

### 一般问题

2. **[protocol_handler_factory.cpp:16-20] ProtocolHandlerFactory::create未按设计实现**
   - 问题描述：根据设计文档，应根据config.get_http2().enabled决定返回Http1Handler还是Http2Handler。当前实现始终返回Http1Handler，忽略了配置参数。
   - 严重程度：一般（扣1分）
   - 建议：实现真正的工厂逻辑：
     ```cpp
     if (config.get_http2().enabled) {
         return std::make_unique<Http2Handler>();
     } else {
         return std::make_unique<Http1Handler>();
     }
     ```

3. **[protocol_types.hpp:20] 错误码定义依赖系统头文件**
   - 问题描述：`PROTOCOL_ERROR_EAGAIN = -EAGAIN` 直接使用了EAGAIN宏，但文件中未包含`<errno.h>`或`<cerrno>`。这依赖于其他头文件的间接包含，移植性差。
   - 严重程度：一般（扣1分）
   - 建议：显式包含`<cerrno>`头文件，或使用固定数值（如-11）并注释说明。

4. **[CMakeLists.txt:19] 存在未使用的旧头文件引用**
   - 问题描述：CMakeLists.txt中列出了`protocol_factory.hpp`，但新增代码使用的是`protocol_handler_factory.hpp`。存在两个工厂类容易造成混淆。
   - 严重程度：一般（扣1分）
   - 建议：确认`protocol_factory.hpp`是否仍在使用，如废弃应从构建中移除并考虑删除文件。

### 建议问题

5. **[config_converter.hpp:29] ConfigConverter全静态类设计**
   - 问题描述：ConfigConverter所有方法都是静态的，没有状态。这使单元测试时无法mock。
   - 严重程度：建议（扣0.1分）
   - 建议：考虑设计为接口+实现类，或允许传入转换策略。

6. **[config_converter.cpp:27] use_gmssl判断逻辑缺少注释说明来源**
   - 问题描述：虽然代码注释提到了"按设计文档规定"，但没有引用设计文档的具体章节或规则编号。
   - 严重程度：建议（扣0.1分）
   - 建议：在注释中补充设计文档的具体章节编号，便于追溯。

7. **[test_protocol.cpp:642-653] 测试用例验证简化实现而非目标行为**
   - 问题描述：`CreateWithHttp2Enabled_ReturnsHttp1HandlerForNow`测试用例验证的是当前简化实现，而非设计文档要求的最终行为。这可能导致未来功能实现后测试未同步更新。
   - 严重程度：建议（扣0.1分）
   - 建议：使用TEST_F_DISABLED或添加明确的TODO注释，确保实现HTTP/2后立即更新测试。

---

## 与设计文档符合度检查

| 设计项 | 实现状态 | 说明 |
|-------|---------|------|
| ConfigConverter类 | ◐ 部分实现 | 缺少国密证书路径映射 |
| ProtocolHandlerFactory类 | ◐ 部分实现 | create()未按配置选择handler |
| 国密支持 | ◐ 部分实现 | use_gmssl标志已设置，但字段不完整 |
| ALPN配置 | ✓ 已实现 | convert_tls_config中正确设置 |
| 单元测试 | ✓ 已实现 | 测试覆盖较完整 |

---

## 总体评价

**详细设计文档评分：93.7分**（满分100分，累计扣6.3分）

扣分明细：
- 重要问题：3分 × 1 = 3分
- 一般问题：1分 × 3 = 3分
- 建议问题：0.1分 × 3 = 0.3分
- 合计：6.3分

**整体评价：**
新增代码整体结构清晰，命名规范，单元测试覆盖较完整。主要问题在于国密支持功能不完整、ProtocolHandlerFactory未按设计实现，以及少量工程规范问题。建议优先解决国密字段映射和工厂逻辑实现，确保与设计文档一致。

---

**报告生成时间：2026-02-21**
**报告版本：第5版**
