# HTTPS Server 模拟器 - 第一轮需求确认

## 确认日期：2026-02-15

---

## 1. HTTPS协议细节

### 报文格式
- **确认**：HTTPS body内容对模拟器来说是二进制流，不关心具体格式
- 由用户自己编码/加密，模拟器直接透传给回调函数

### TLS版本
- **确认**：TLS 1.2 和 TLS 1.3 都需要支持

### 证书
- **确认**：需要支持多种证书类型
  - 国际证书
  - 国密证书
  - 自定义证书（用户提供证书文件和对应TLS版本）

---

## 2. C接口回调细节

### 回调函数签名
```c
// 内容解析函数（异步）
uint32_t AsyncParseContent(const uint8_t *in, uint32_t inLen);

// 内容解析函数（异步输出，初始化注入）
uint32_t AsyncReplyContent(uint8_t *out, uint32_t *outLen);
```

### 回调加载方式
- **确认**：静态加载
- 通过CMakeLists封装成object，在制作可执行文件时链接进去
- **注意**：
  - 内容回调处理：可能同时注入多个object，建议采用策略模式进行拉起
  - 证书：提前准备好文件

### 回调上下文 - **待确认**
- 用户表示没看懂，需要进一步解释

---

## 3. Client生命周期管理

### 连接建立条件
- TCP三次握手 + TLS认证成功，两者都通过后算连接建立

### 连接断开策略
- Server模拟器可配置断开响应时间
- 例如：配置30s，client和模拟server连接通后，自模拟server回复client最后一条消息后30s，client没有再响应模拟server，就认为断链
- 模拟server断链后会主动给client发一个结束的消息

### 超时机制
- 默认30s，可配置（通过配置文件）

### 生命周期状态
- **确认**：所有状态都需要关注（已连接、握手完成、报文中、已断开等）

---

## 4. Debug字段与调测点

### Debug字段位置 - **待确认**
- 用户未回答，需要确认：debug字段在HTTP header里，还是在HTTPS的应用层报文内容里？

### 调测点
- **确认**需要的调测点：
  - 延迟响应时间
  - 强制断开连接
  - 记录报文日志
  - 返回特定错误码
- **用户补充**：
  - 最好做成职责链模式
  - 调测可叠加
  - 支持后续拓展

---

## 5. 适配层（Python 3.8）

### 界面形式
- **确认**：两者都需要
  - 命令行界面（CLI）- 必须有，支持python命令进入
  - GUI图形界面 - 需要，在Windows上使用

### 配置方式
- **确认**：配置文件方式，使用JSON格式

---

## 6. 项目结构与构建

### 构建系统
- **确认**：CMake
- 需要支持的架构：x86、x86_64、arm、arm64
- **用户补充**：
  - 所有三方库需要源码克隆到项目目录的third_party里面
  - 进行源码编译，提供给当前工程使用

### 目录结构
- **用户建议**：
```
工程目录
├── docs
├── codes
│   ├── api
│   │   ├── adapt      (将core的server模拟器的动态库封装成可执行文件)
│   │   ├── cli
│   │   ├── app
│   │   └── Test
│   └── core
│       ├── include
│       │   └── ……
│       ├── source
│       │   └── ……
│       └── test
│           ├── sim_client
│           │   └── ……
│           └── ……
├── prompts              (用户维护)
└── scripts
    ├── build_project.py
    ├── server_sim_cli.py
    └── server_sim_app.py
```

---

## 待确认的问题

1. Debug字段位置：在HTTP header里还是在HTTPS的应用层报文内容里？
2. 回调上下文：需要解释清楚这个概念，然后确认是否需要传递client相关上下文
3. HTTP协议层面：是HTTP/1.1、HTTP/2、还是两者都要？
4. C接口回调的异步机制：这两个函数是如何配合工作的？是多线程吗？
5. "结束的消息"：断链后主动给client发的结束消息是什么格式？
6. 多个回调策略：策略模式的选择逻辑是什么？根据什么条件选择哪个回调object？
